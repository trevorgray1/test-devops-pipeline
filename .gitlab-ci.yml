# GitLab CI/CD pipeline for sample-app

stages:
  - test
  - build
  - publish

test:
  stage: test
  image: python:3.9
  script:
    - python -m pip install --upgrade pip
    - pip install -r sample-app/requirements.txt
    - cd sample-app/testpkg
    - python -m pytest test_testpkg.py
  artifacts:
    paths:
      - sample-app/testpkg/__pycache__/

build:
  stage: build
  image: python:3.9
  script:
    - cd sample-app/testpkg
    - python3 -m pip install --upgrade setuptools wheel
    - python3 setup.py sdist bdist_wheel
  artifacts:
    paths:
      - sample-app/testpkg/dist/
  dependencies:
    - test

publish:
  stage: publish
  image: python:3.9
  script:
    - pip install cloudsmith-cli
    - cd sample-app/testpkg
    - cloudsmith push python $CLOUDSMITH_OWNER/$CLOUDSMITH_REPO dist/*.whl
    - cloudsmith push python $CLOUDSMITH_OWNER/$CLOUDSMITH_REPO dist/*.tar.gz
  dependencies:
    - build
  only:
    - main
  #Set CLOUDSMITH_OWNER, CLOUDSMITH_REPO, CLOUDSMITH_API_KEY in GitLab CI/CD > Settings > Variables
