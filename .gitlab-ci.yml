# GitLab CI/CD pipeline for sample-app

stages:
  - test
  - build
  - publish

test:
  stage: test
  image: python:3.9
  script:
    - python -m pip install --upgrade pip
    - pip install -r sample-app/requirements.txt
    - cd sample-app
    - python -m pytest
  artifacts:
    paths:
      - sample-app/__pycache__/

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t sample-app:latest ./sample-app
  dependencies:
    - test

publish:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "$CLOUDSMITH_API_KEY" | docker login docker.cloudsmith.io -u "$CLOUDSMITH_OWNER" --password-stdin
    - docker tag sample-app:latest docker.cloudsmith.io/$CLOUDSMITH_OWNER/$CLOUDSMITH_REPO/sample-app:latest
    - docker push docker.cloudsmith.io/$CLOUDSMITH_OWNER/$CLOUDSMITH_REPO/sample-app:latest
  dependencies:
    - build
  only:
    - main
  variables:
    CLOUDSMITH_OWNER: "trevor-gray"
    CLOUDSMITH_REPO: "test-repo1"
    CLOUDSMITH_API_KEY: "$CLOUDSMITH_API_KEY"
  #update with your actual Cloudsmith API key in GitLab CI/CD variables settingss
